name: Generate Demo GIF

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - assets/demo.svg
      - .github/workflows/generate-demo-gif.yml

permissions:
  contents: write

jobs:
  build-gif:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick librsvg2-bin fonts-dejavu-core
      - name: Render frames from SVG
        run: |
          set -euo pipefail
          mkdir -p .work
          rsvg-convert -w 1040 -h 360 assets/demo.svg -o .work/base.png
          # Frame 1: initial
          cp .work/base.png .work/frame1.png
          # Frame 2: auto-continue
          convert .work/base.png -gravity South -fill '#c9d1d9' -pointsize 18 -font DejaVu-Sans-Mono -annotate +0+38 '… auto-continue' .work/frame2.png
          # Frame 3: pytest exit 1
          convert .work/base.png -gravity South -fill '#d29922' -pointsize 18 -font DejaVu-Sans-Mono -annotate +0+38 'success_cmd: pytest -q  → exit=1' .work/frame3.png
          # Frame 4: success exit 0
          convert .work/base.png -gravity South -fill '#3fb950' -pointsize 18 -font DejaVu-Sans-Mono -annotate +0+38 'SUCCESS proof: exit code 0 — exiting' .work/frame4.png
      - name: Assemble GIF
        run: |
          set -euo pipefail
          mkdir -p assets
          convert \
            -loop 0 \
            -delay 120 .work/frame1.png \
            -delay 90  .work/frame2.png \
            -delay 90  .work/frame3.png \
            -delay 140 .work/frame4.png \
            -colors 128 -dither FloydSteinberg -layers Optimize \
            assets/tui-demo.gif
          identify assets/tui-demo.gif || true
      - name: Commit GIF if changed
        run: |
          set -euo pipefail
          if git status --porcelain -- assets/tui-demo.gif | grep -q '^ M\|^??'; then
            git config user.name 'github-actions'
            git config user.email 'github-actions@users.noreply.github.com'
            git add assets/tui-demo.gif
            git commit -m 'docs(demo): auto-generate GIF from demo.svg [skip ci]'
            git push
          else
            echo 'No changes to GIF.'
          fi
